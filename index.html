<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Deep Research Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light">
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <div class="header-inner container">
      <div class="brand"><div class="logo" aria-hidden="true"></div> Deep Research Hub</div>
      <div class="tagline">professional stock research • signal over noise</div>
      <div class="header-actions">
        <button class="toggle" id="copyHome">Copy URL</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Controls -->
    <section class="panel" aria-labelledby="controls">
      <h2 id="controls">Browse research</h2>
      <div class="row" style="margin-top:8px">
        <label for="q">Search</label>
        <input id="q" type="text" placeholder="Filter by title, ticker, category, or tag…" />
        <label for="cat">Category</label>
        <select id="cat"><option value="">All</option></select>
        <label for="sort">Sort</label>
        <select id="sort">
          <option value="newest">Newest first</option>
          <option value="title">Title A–Z</option>
        </select>
      </div>
      <div class="meta">
        <span id="count"></span>
      </div>
    </section>

    <!-- Grid -->
    <section class="grid" id="grid" aria-live="polite"></section>
  </main>

  <footer class="container">
    <span>© <span id="year"></span> Deep Research Hub</span>
    <span class="sep">•</span>
    <span>Built for serious traders</span>
  </footer>

  <script>
    const S = {
      data: [],
      q: "",
      cat: "",
      sort: "newest"
    };

    const fmtDate = (dStr)=>{
      if(!dStr) return "";
      const d = new Date(dStr);
      if(isNaN(d)) return dStr;
      return d.toLocaleDateString(undefined, {year:"numeric", month:"short", day:"2-digit"});
    };

    function cardHTML(item){
      const tags = (item.tags||[]).map(t=>`<span class="pill">#${t}</span>`).join("");
      const cat  = item.category ? `<span class="pill pill--muted">#${item.category}</span>` : "";
      const date = item.date ? `<span class="badge">${fmtDate(item.date)}</span>` : "";
      const tick = (item.tickers||[])
                    .map(t=>`<span class="mono chip-ticker">${t}</span>`).join("");
      return `
        <article class="card">
          <div class="card-head">
            <div class="card-title">${item.title}</div>
            ${date}
          </div>
          <div class="card-meta">
            <div class="card-line">
              ${cat} ${tags}
            </div>
            <div class="card-line">
              ${tick}
            </div>
          </div>
          <div class="card-actions">
            <a class="btn primary" href="viewer.html?doc=${encodeURIComponent(item.id)}">Open</a>
            <a class="btn ghost" target="_blank" rel="noopener" href="viewer.html?doc=${encodeURIComponent(item.id)}">New tab</a>
          </div>
        </article>
      `;
    }

    function render(){
      // filter
      const q = S.q.trim().toLowerCase();
      let rows = S.data.filter(it=>{
        const hay = [
          it.title, it.category, ...(it.tags||[]), ...(it.tickers||[])
        ].join(" ").toLowerCase();
        const qok = !q || hay.includes(q);
        const cok = !S.cat || (it.category||"") === S.cat;
        return qok && cok;
      });

      // sort
      if(S.sort==="title"){
        rows.sort((a,b)=> (a.title||"").localeCompare(b.title||""));
      } else {
        rows.sort((a,b)=>{
          if(a.date && b.date) return new Date(b.date) - new Date(a.date);
          return (b.id||"").localeCompare(a.id||"");
        });
      }

      // render
      document.getElementById("grid").innerHTML = rows.map(cardHTML).join("");
      document.getElementById("count").textContent =
        `${rows.length} result${rows.length===1?"":"s"} · ${S.data.length} total`;
    }

    async function init(){
      document.getElementById("year").textContent = new Date().getFullYear();
      document.getElementById("copyHome").addEventListener("click", async ()=>{
        try{ await navigator.clipboard.writeText(location.href); alert("URL copied"); }catch(e){ alert("Copy failed");}
      });

      // load
      const res = await fetch("manifest.json", { cache: "no-store" });
      const manifest = await res.json();
      S.data = manifest;

      // categories
      const cats = [...new Set(manifest.map(x=>x.category).filter(Boolean))].sort();
      const catSel = document.getElementById("cat");
      cats.forEach(c=>{
        const opt = document.createElement("option");
        opt.value = c; opt.textContent = c;
        catSel.appendChild(opt);
      });

      // search + filters
      document.getElementById("q").addEventListener("input", e=>{ S.q = e.target.value; render(); });
      catSel.addEventListener("change", e=>{ S.cat = e.target.value; render(); });
      document.getElementById("sort").addEventListener("change", e=>{ S.sort = e.target.value; render(); });

      render();
    }
    init();
  </script>
</body>
</html>
